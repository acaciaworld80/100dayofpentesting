import axmlparserpy.apk as apk
import os
import csv
import magic

def list_service(app):
	result = []
	name = app.get_elements("service","android:name")
	export = app.get_elements("service","android:exported")

	for n,e in zip(name,export):
		if "true" in e:
			n += ":true"
			result.append(n)
		else:
			n += ":false"
			result.append(n)		

	return ' \n'.join(result)


def list_activities(app):
	result = []

	name = app.get_elements("activity","android:name")
	export = app.get_elements("activity","android:exported")

	for n,e in zip(name,export):
		if "true" in e:
			n += ":true"
			result.append(n)
		else:
			n += ":false"
			result.append(n)		

	return ' \n'.join(result)

def list_provider(app):
	result = []

        name = app.get_elements("provider","android:name")
        export = app.get_elements("provider","android:exported")

	for n,e in zip(name,export):
		if "true" in e:
			n += ":true"
			result.append(n)
		else:
			n += ":false"
			result.append(n)

	return ' \n'.join(result)

def list_receiver(app):
	result = []
        name = app.get_elements("receiver","android:name")
        export = app.get_elements("receiver","android:exported")

	for n,e in zip(name,export):
		if "true" in e:
			n += ":true"
			result.append(n)
		else:
			n += ":false"
			result.append(n)

	return " \n".join(result)

def check_backup(app):
	backup = app.get_elements("application","android:allowBackup")
	if "true" in backup[0]:
		return "true"
	else:
		return "false"

def list_permission(app):
	perm = app.get_permissions()
	return " \n".join(perm)

list_file =  os.listdir(os.getcwd()) #get all apk file in directory
header = ['Package Name','Version','Backup','Permission',"Activities","Content Provider",
"Service","Broadcast Receiver"]

result = open("apk_result.csv","w")

if len(list_file) == 0:
	print "HELP: you need to put it inside a directory that contain multiple .apk files"
else:
	print "####################################################################"
	print "apk_mapper v 1.0: tools to mapping multiple apk manifest file for analysis"
	print "PLEASE DONT change the name of the python file !"
	print "CREATED BY: williams"
	print "####################################################################"

	writer = csv.writer(result) #put a header in csv
	writer.writerow(header)

	for x in list_file:
		file_ext = magic.from_file(x,mime=True)
		if file_ext == "application/zip":
			result = []
			app = apk.APK(x)
			result.append(app.get_package()) #print app name
			result.append(app.get_androidversion_name()) #print app version
			result.append(check_backup(app))
			result.append(list_permission(app)) #print permission
			result.append(list_activities(app)) #print activity
			result.append(list_provider(app)) #print provider
			result.append(list_service(app))
			result.append(list_receiver(app))
			writer.writerow(result)
